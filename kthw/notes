

To do:
-----
* Worker nodes
* Consider creating a systemd library with common functions like install, uninstall,
    status, etc. for easier management
* Logging library
* Consider a copying engine - you write a file that describes what to copy where,
    and the engine makes sure to perform it - instead of writing it in the 'distribute' function
* Consider ansible?
* etcd: test that systemd service is running
* control-plane: add test


Bugs:
-----
* when running clean_nodes in control-plane, it deletes
kubectl in all the controller machines, but we need it 
to generate the kubeconfigs


Deployment process:
--------
When we come to deploy on the nodes, we basically do the following steps:
- install prerequisites (check if fulfilled, if not install)
- scp files (service files, certificates, kubeconfigs, setup script, etc.)
- copy files to correct location (setup script?)
- install systemd service
- run systemd service

We want to allow the user at any moment:
- stop the services
- uninstall the services
- prune (delete everything we've copied)
- check status







Planning of deployment process
=============================

(talking here about etcd, but relevant for control plane and kubelet)

etcd_agent.sh
-----------
commands:
	- install_binaries:
		purpose: install etcd software and necessary prerequisites
		runs:
		- install_binaries
		side effects: etcd is installed on the machine (state 3)
		
	- uninstall_binaries:
		purpose: remove etcd software
		depends: stop
		runs:
		- uninstall_binaries
		side effects: remove etcd software (state 2)
		
	- install_service:
		purpose: install service files etc.
		runs:
		- install_service
		side effects: configuration files are installed, directories created, service enabled (state 4)
		
	- uninstall_service:
		purpose: remove the service and all configuration files
		depends: stop
		runs:
		- uninstall 
		side effects: clean configuration files and service file, delete directories (state 3)

	- start:
		purpose: start the service
		depends: install, install_prerequisites
		runs:
		- start
		side effects: etcd service running (state 5)

	- stop:
		purpose: stop the service
		runs:
		- stop	
		side effects: etcd service stops (state 4)
			
	- status:
		- status
	
	- full_run
		- install_binaries
		- install_service
		- start
		
	- reset
		- stop
		- uninstall_service
		- uninstall_binaries


functions:
	install_etcd_bins: (state 2 -> 3)
		- check sudoer
		- download etcd binaries
		- install them
		returns: 0/1
	
	uninstall_etcd_bins (state 3 -> 2)
		- check sudoer
		- remove binaries
		returns: 0/1
	
	install: (state 2 -> 4)
		- check sudoer
		- check files exist
		- create directories
		- copy certificates
		- copy service files
		- enable service (if fails - remove previous steps)
	
	start: (state 4 -> 5)
		- check service is loaded (status)
		- check binaries installed (status)
		- start service
		
	stop: (state 5 -> 4)
		- check status - if running
		- check status - if loaded
		- stop service
		
	uninstall: (state 4 -> 2)
		- check status - if running
		- check status - if enabled
		- disable service
		- rm files and directories
	
	status:
		- returns a json
		{
			"active": true
			"loaded": true
			"etcd_installed": true
			"files_installed": true
			"landed": true
		}
	
		



#############################
			
		
etcd_manager.sh
---------------
commands:
	 - create_deployment
	 	purpose: create a deployment directory with all files to copy to nodes
	 	runs:
	 	- create_deployment
	 	side effects: deployment directory
	 	
	 - delete_deployment - clean deployment directory
	 	purpose: delete deployment directory
	 	runs: clean
	 	side effects: deployment directory deleted
	 	
	 - install
	 	purpose: install etcd binaries, configuration files and load service on all nodes
	 	start state: 0
	 	runs:
	 	- distribute (state 2)
	 	- install_binaries (state 3) -> if fails, clean
	 	- install_service (state 4)  -> if fails, uninstall_binaries, clean 
	 	side effects: etcd bins installed, files scp'd, configuraion files in place,  service installed (state 0 -> 4)
	 	if fails between nodes: uninstall from all nodes
	 	
	 - uninstall 
	 	purpose: uninstall on all nodes
	 	start state: 4
	 	runs:
	 	- uninstall_service (state 3)
	 	- uninstall binaries (state 2)
	 	side effects: etcd unintsalled on all nodes (state 4 -> 2)
	 	if fails between nodes: warn, continue to next nodes
	 	
	 - clean_nodes
	 	purpose: delete etcd software and etcd_home
	 	start state: 2
	 	runs:
	 	- clean_etcd_home
	 	side effects: etcd_home delete (state 2 -> 1)
	 	
	 - start
	 	purpose: start etcd
	 	start  state: 4
	 	runs:
	 	- start
	 	side effects: etcd up (state 5)
	 	if fails between nodes: stop on previous nodes
	 
	 - stop
	 	purpose: stop etcd
	 	start state: 5
	 	runs:
	 	- stop
	 	side effecst: etcd down (state 4)
	 	if fails between nodes: warn, continue to next nodes
	 	
	 - test
	 	purpose: test etcd
	 	start state: 5
	 	runs:
	 	- test
	 
	 - status - returns a report of the etcd state
	 
	 - full_run - create_deployment + run
	 - reset
	 	purpose: leave no mark of etcd
	 	runs:
	 	- stop
	 	- 
	
functions:
	- clean_etcd_home - delete etcd_home directory from all nodes
	- create_deployment
		- patch agent script
		- generate service files
		
	- distribute
		- scp to all nodes
		remarks: if some node fails, delete from other nodes
	
	- clean_etcd_home
		- delete etcd_home from all nodes
		remarks: if some node fails, warn and continue
	
	- install_binaries
		does:
		- check status - should be 'landed'
		- run agent.sh install_binaries (state 3)
		remarks: if some node fails, clean previous nodes
	
	- uninstall_binaries
		does:
		- remove etcd binaries
		remarks: if some node fails, warn and continue
		
	- install_service
		depends: distribute
		does:
		- check status - should be uninstalled - if installed - raise warning and return
		- run agnet.sh install (state 4)
		remarks: if some node fails, uninstall from all nodes
		
	- uninstall_service
		does:
		- check status - should be installed
		- run agent.sh uninstall (state 3)
		remarks: if some node fails, warn and continue
		
	- start
		does:
		- check status - should be installed
		- start etcd service on all nodes
		remarks: if some node fails, stop previous nodes
		
	- stop
		does:
		- check status - should be started
		- stop etcd service on all nodes
		remarks: if some node fails, raise warning and continue
		
	- test
		test etcd is up and running
		
	- status
		does:
		- foreach node, display status




possible states:
1) clean - nothing on node
2) landed - files in k8s_home
3) etcd_installed - etcd binaries installed
4) service_installed - files installed on machine, service enabled
5) started - service running





